# 多摄像头行车记录仪 (Multi-Camera Dashcam)

一个功能强大的Android车载行车记录仪应用，支持同时录制四个摄像头的视频，具备GPS定位、碰撞检测和紧急视频保护功能。

## 主要功能

### 📹 多摄像头录制
- 同时录制4个摄像头（前、后、左、右）
- 支持多种分辨率：720P、1080P、2K、4K
- 可调帧率：24fps、30fps、60fps
- 自动分段录制（30秒-5分钟可选）

### 📍 GPS定位
- 实时GPS位置记录
- 速度和方向追踪
- GPS数据嵌入视频文件
- 实时速度显示

### 🚨 碰撞检测
- 基于G-sensor的智能碰撞检测
- 检测急刹车、急转弯
- 可调灵敏度
- 自动触发紧急保护

### 💾 智能存储管理
- 循环录制（自动删除旧视频）
- 紧急视频保护（碰撞时自动保护）
- 可配置最小保留空间
- 分类存储（普通/保护）

### 🎨 视频水印
- **预览叠加**：实时在预览界面显示水印信息
- **水印烧录**：使用FFmpeg将水印永久写入视频流，满足法规要求
- **字幕导出**：可选生成SRT字幕文件，包含所有水印数据
- 显示内容：时间戳、GPS坐标、速度、方向、摄像头位置
- 支持自定义文本（如车牌号、车辆信息）
- 四种位置选择（左上/右上/左下/右下）
- 两种水印方式：烧录到视频（推荐，满足合规要求）或字幕文件

### 🎯 其他特性
- 四分屏实时预览
- 前台服务持续录制
- 开机自启动
- 完整的设置界面
- 后台录制，不影响其他应用使用

## 系统要求

- Android 8.0 (API 26) 及以上
- 至少2个摄像头（支持4个摄像头效果最佳）
- GPS模块
- 加速度计
- 推荐2GB以上存储空间

## 项目结构

```
app/src/main/java/com/dashcam/multicam/
├── model/              # 数据模型
│   ├── CameraConfig.kt        # 摄像头配置、GPS数据、传感器数据
│   └── WatermarkConfig.kt     # 水印配置和数据模型
├── manager/            # 管理器
│   ├── MultiCameraManager.kt  # 多摄像头管理
│   ├── StorageManager.kt      # 存储管理
│   ├── GpsManager.kt          # GPS管理
│   ├── SensorManager.kt       # 传感器管理
│   └── WatermarkManager.kt    # 水印管理
├── service/            # 服务
│   ├── RecordingService.kt    # 录制服务
│   └── BootReceiver.kt        # 开机自启动
├── ui/                 # 用户界面
│   ├── MainActivity.kt        # 主界面
│   ├── SettingsActivity.kt    # 设置界面
│   └── WatermarkOverlayView.kt # 水印叠加视图
└── utils/              # 工具类
    ├── VideoRecorder.kt            # 视频录制器
    ├── VideoWatermarkEncoder.kt    # 视频水印编码器
    ├── FFmpegWatermarkBurner.kt    # FFmpeg水印烧录器
    └── WatermarkSubtitleGenerator.kt # 字幕文件生成器
```

## 核心技术

### CameraX API
使用Google推荐的CameraX库实现多摄像头录制：
- 简化的相机生命周期管理
- 跨设备兼容性好
- 支持同时使用多个摄像头
- 高质量视频编码

### 协程和Flow
使用Kotlin协程处理异步任务：
- GPS数据流
- 传感器数据流
- 录制状态管理
- 分段录制调度

### 前台服务
确保录制不被系统杀掉：
- 前台服务通知
- 相机和位置服务类型
- 生命周期管理

### FFmpegKit集成
使用FFmpegKit实现水印烧录：
- 完整的FFmpeg功能支持
- 高质量视频处理
- drawtext滤镜实现水印叠加
- H.264编码保持视频兼容性

## 使用说明

### 安装和启动

1. 构建项目：
```bash
./gradlew build
```

2. 安装APK到设备：
```bash
./gradlew installDebug
```

3. 首次启动时授予所需权限：
   - 摄像头权限
   - 录音权限
   - 位置权限
   - 存储权限

### 基本操作

1. **开始录制**：点击"开始录制"按钮
2. **停止录制**：点击"停止录制"按钮
3. **紧急保护**：点击"紧急保护"按钮手动保护当前视频
4. **设置**：点击"设置"按钮调整各项参数

### 设置选项

#### 视频设置
- **视频质量**：选择录制分辨率（720P-4K）
- **帧率**：选择视频帧率（24-60fps）
- **分段时长**：设置每段视频的长度

#### 存储设置
- **最小保留空间**：设置自动清理时保留的空间
- **自动清理**：启用/禁用循环录制

#### GPS设置
- **启用GPS**：是否记录GPS数据
- **显示速度**：是否在界面显示速度

#### 碰撞检测
- **启用碰撞检测**：开启/关闭碰撞检测
- **灵敏度**：调整检测灵敏度

#### 水印设置
- **启用水印**：是否在视频上显示水印
- **显示时间戳**：在水印中显示日期和时间
- **显示GPS坐标**：在水印中显示位置信息
- **显示速度**：在水印中显示当前速度
- **显示摄像头名称**：标识视频来源（前/后/左/右）
- **自定义文本**：添加自定义文本（如车牌号）
- **水印位置**：选择水印显示位置（左上/右上/左下/右下）
- **烧录水印到视频**：使用FFmpeg将水印永久写入视频文件（满足法规要求，处理时间较长）
- **生成字幕文件**：为每个视频自动生成SRT字幕文件（烧录水印时自动禁用）

#### 系统设置
- **开机自启动**：系统启动时自动开始录制
- **保持屏幕常亮**：录制时保持屏幕开启

## 视频文件组织

```
DashcamVideos/
├── Normal/                    # 普通录制视频
│   ├── FRONT/                # 前摄像头
│   │   ├── NORMAL_FRONT_20231215_143022.mp4
│   │   └── NORMAL_FRONT_20231215_143022.srt   # SRT字幕文件
│   ├── REAR/                 # 后摄像头
│   ├── LEFT/                 # 左摄像头
│   └── RIGHT/                # 右摄像头
└── Protected/                 # 受保护视频（碰撞时）
    ├── FRONT/
    ├── REAR/
    ├── LEFT/
    └── RIGHT/
```

**水印实现方式**：
1. **烧录到视频**（推荐，满足法规要求）：
   - 使用FFmpeg将水印永久写入视频流
   - 水印成为视频的一部分，无法移除
   - 满足法律法规对行车记录仪水印的要求
   - 处理需要一定时间，在每段录制完成后自动处理

2. **SRT字幕文件**（可选）：
   - SRT格式，与视频文件同名
   - 包含时间戳、GPS、速度等水印信息
   - 可在VLC、MX Player等播放器中自动加载
   - 适合需要灵活显示水印的场景

## 技术细节

### 循环录制
当存储空间低于设定阈值时，自动删除最旧的普通视频（保护的视频不会被删除）。

### 碰撞检测算法
通过加速度计监测：
- 总加速度 > 20 m/s² → 碰撞
- Z轴加速度 > 15 m/s² → 急刹车
- X/Y轴加速度 > 15 m/s² → 急转弯

### GPS数据格式
GPS数据包含：
- 纬度/经度
- 海拔高度
- 速度（m/s）
- 方向角度
- 时间戳

## 权限说明

| 权限 | 用途 |
|------|------|
| CAMERA | 访问摄像头录制视频 |
| RECORD_AUDIO | 录制音频 |
| ACCESS_FINE_LOCATION | 获取精确GPS位置 |
| ACCESS_COARSE_LOCATION | 获取粗略位置 |
| WRITE_EXTERNAL_STORAGE | 保存视频文件（Android 9及以下） |
| FOREGROUND_SERVICE | 前台服务持续录制 |
| WAKE_LOCK | 保持设备唤醒 |
| RECEIVE_BOOT_COMPLETED | 开机自启动 |

## 已知限制

1. **摄像头数量**：大多数手机只有2个摄像头，需要外接USB摄像头实现4路录制
2. **性能要求**：同时录制4路高清视频需要较强的处理器
3. **存储速度**：建议使用UHS-I或更快的存储卡
4. **电池消耗**：持续录制会消耗较多电量，建议连接车载电源

## 未来改进

- [ ] 支持视频播放和回放
- [ ] 云端备份功能
- [ ] AI事件检测（行人、车辆等）
- [ ] 夜间模式优化
- [ ] 停车监控模式
- [ ] H.265编码支持
- [ ] Wi-Fi文件传输
- [ ] 视频编辑和剪辑功能
- [ ] 实时水印烧录（当前为后处理）

## 许可证

MIT License - 详见 LICENSE 文件

## 贡献

欢迎提交Issue和Pull Request！

## 联系方式

如有问题或建议，请提交Issue。
